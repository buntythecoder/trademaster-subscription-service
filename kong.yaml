# Kong Gateway Configuration for TradeMaster Subscription Service
# Compatible with Kong Gateway 3.x and Kong Ingress Controller

_format_version: "3.0"

# ==================== SERVICES ====================
services:
  - name: trademaster-subscription-service
    protocol: http
    host: subscription-service
    port: 8085
    path: /api
    retries: 3
    connect_timeout: 10000
    write_timeout: 30000
    read_timeout: 30000
    tags:
      - trademaster
      - subscription
      - production

# ==================== UPSTREAMS ====================
upstreams:
  - name: subscription-service-upstream
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    hash_on_cookie_path: /
    slots: 10000
    healthchecks:
      active:
        type: http
        timeout: 5
        concurrency: 5
        http_path: /api/v2/health
        https_verify_certificate: false
        healthy:
          interval: 10
          http_statuses: [200, 201, 202, 204]
          successes: 3
        unhealthy:
          interval: 5
          http_statuses: [429, 500, 502, 503, 504]
          tcp_failures: 3
          http_failures: 3
          timeouts: 3
      passive:
        type: http
        healthy:
          http_statuses: [200, 201, 202, 204, 301, 302, 401, 403, 404]
          successes: 3
        unhealthy:
          http_statuses: [429, 500, 502, 503, 504]
          tcp_failures: 3
          http_failures: 3
          timeouts: 3
      threshold: 0
    tags:
      - trademaster
      - subscription
    targets:
      - target: subscription-service:8085
        weight: 100
        tags:
          - primary

# ==================== ROUTES ====================
routes:
  # Public Test Routes (No Authentication)
  - name: subscription-test-ping
    service: trademaster-subscription-service
    protocols: [http, https]
    methods: [GET, OPTIONS]
    paths: ["/v1/test/ping", "/v1/test/headers"]
    preserve_host: false
    strip_path: false
    tags:
      - test
      - public

  # Health Check Routes (Public)
  - name: subscription-health-check
    service: trademaster-subscription-service
    protocols: [http, https]
    methods: [GET, OPTIONS]
    paths: ["/v2/health", "/v2/ping", "/health", "/ready", "/alive", "/status"]
    preserve_host: false
    strip_path: false
    tags:
      - health
      - monitoring

  # Main Subscription API Routes (JWT Authentication)
  - name: subscription-api-main
    service: trademaster-subscription-service
    protocols: [http, https]
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    paths: ["/v1/subscriptions", "/v1/subscriptions/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - subscriptions
      - api
      - jwt-required

  # Subscription Test Routes (JWT Authentication)
  - name: subscription-test-secure
    service: trademaster-subscription-service
    protocols: [http, https]
    methods: [GET, POST, OPTIONS]
    paths: ["/v1/test/secure", "/v1/test/load"]
    preserve_host: false
    strip_path: false
    tags:
      - test
      - secure
      - jwt-required

  # Internal API Routes (API Key Authentication)
  - name: subscription-internal-api
    service: trademaster-subscription-service
    protocols: [http, https]
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    paths: ["/internal", "/internal/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - internal
      - service-to-service
      - api-key-required

# ==================== PLUGINS ====================
plugins:
  # CORS Plugin (Global)
  - name: cors
    config:
      origins:
        - "https://app.trademaster.com"
        - "https://admin.trademaster.com"
        - "http://localhost:3000"  # Development
        - "http://localhost:8080"  # Development
        - "http://localhost:8085"  # Development
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - HEAD
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
        - X-API-Key
        - X-Correlation-ID
        - X-User-ID
        - X-Request-ID
      exposed_headers:
        - X-Auth-Token
        - X-API-Key
        - X-Correlation-ID
        - X-User-ID
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags:
      - cors
      - global

  # Rate Limiting Plugin (Global)
  - name: rate-limiting
    config:
      minute: 1000
      hour: 50000
      day: 1000000
      month: 25000000
      year: 300000000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      header_name: X-RateLimit-Limit
      limit_by: consumer
    tags:
      - rate-limiting
      - global

  # Request ID Plugin (Correlation ID)
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true
    tags:
      - correlation
      - tracing

  # Prometheus Metrics Plugin
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
    tags:
      - metrics
      - monitoring

  # Request Logging Plugin
  - name: http-log
    config:
      http_endpoint: "http://log-aggregator:8080/kong-logs"
      method: POST
      timeout: 1000
      keepalive: 1000
      content_type: application/json
      flush_timeout: 2
      retry_count: 3
      queue_size: 100
    tags:
      - logging
      - audit

  # JWT Authentication Plugin (Applied to main subscription routes)
  - name: jwt
    route: subscription-api-main
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      header_names:
        - authorization
      claims_to_verify:
        - exp
        - iat
      key_claim_name: iss
      secret_is_base64: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - jwt

  # JWT Authentication Plugin (Applied to secure test routes)
  - name: jwt
    route: subscription-test-secure
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      header_names:
        - authorization
      claims_to_verify:
        - exp
        - iat
      key_claim_name: iss
      secret_is_base64: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - jwt
      - test

  # API Key Authentication Plugin (Applied to internal routes)
  - name: key-auth
    route: subscription-internal-api
    config:
      key_names:
        - X-API-Key
        - api-key
      key_in_header: true
      key_in_query: false
      key_in_body: false
      hide_credentials: true
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - api-key
      - internal

  # Enhanced Rate Limiting for Subscription Creation
  - name: rate-limiting
    route: subscription-api-main
    config:
      minute: 60       # 60 subscription operations per minute per user
      hour: 1000       # 1000 subscription operations per hour per user
      day: 5000        # 5000 subscription operations per day per user
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      limit_by: consumer
    tags:
      - rate-limiting
      - subscriptions

  # Request Size Limiting for Subscription Requests
  - name: request-size-limiting
    route: subscription-api-main
    config:
      allowed_payload_size: 2048  # 2KB for subscription requests
    tags:
      - request-size
      - security
      - subscriptions

  # IP Restriction for Internal APIs
  - name: ip-restriction
    route: subscription-internal-api
    config:
      allow:
        - "10.0.0.0/8"      # Internal network
        - "172.16.0.0/12"   # Docker networks
        - "192.168.0.0/16"  # Private networks
        - "127.0.0.1"       # Localhost
      deny: []
      message: "Access denied from this IP - Internal API access only"
    tags:
      - ip-restriction
      - internal
      - security

  # Response Rate Limiting (Circuit Breaker)
  - name: response-ratelimiting
    route: subscription-api-main
    config:
      limits:
        json:
          minute: 100
          hour: 1000
      block_on_first_violation: false
      fault_tolerant: true
      hide_client_headers: false
    tags:
      - response-rate-limiting
      - circuit-breaker

# ==================== CONSUMERS ====================
consumers:
  - username: trademaster-subscription-app
    custom_id: subscription-app-001
    tags:
      - application
      - frontend
      - subscription

  - username: trademaster-subscription-admin
    custom_id: subscription-admin-001
    tags:
      - admin
      - backend
      - subscription

  - username: trademaster-subscription-monitor
    custom_id: subscription-monitor-001
    tags:
      - monitoring
      - system
      - subscription

  # Internal Service Consumers
  - username: trademaster-trading-service
    custom_id: trading-service-001
    tags:
      - service
      - internal
      - trading

  - username: trademaster-notification-service
    custom_id: notification-service-001
    tags:
      - service
      - internal
      - notification

  - username: trademaster-billing-service
    custom_id: billing-service-001
    tags:
      - service
      - internal
      - billing

# ==================== CONSUMER CREDENTIALS ====================
jwt_secrets:
  - consumer: trademaster-subscription-app
    key: trademaster-subscription-app-key
    algorithm: HS256
    secret: "${TRADEMASTER_SUBSCRIPTION_JWT_SECRET}"
    tags:
      - jwt-secret
      - app
      - subscription

  - consumer: trademaster-subscription-admin
    key: trademaster-subscription-admin-key
    algorithm: HS256
    secret: "${TRADEMASTER_SUBSCRIPTION_ADMIN_JWT_SECRET}"
    tags:
      - jwt-secret
      - admin
      - subscription

keyauth_credentials:
  - consumer: trademaster-subscription-admin
    key: "${TRADEMASTER_SUBSCRIPTION_ADMIN_API_KEY}"
    tags:
      - api-key
      - admin
      - subscription

  - consumer: trademaster-subscription-monitor
    key: "${TRADEMASTER_SUBSCRIPTION_MONITOR_API_KEY}"
    tags:
      - api-key
      - monitor
      - subscription

  # Internal Service API Keys
  - consumer: trademaster-trading-service
    key: "${TRADEMASTER_TRADING_SERVICE_API_KEY}"
    tags:
      - api-key
      - internal
      - trading

  - consumer: trademaster-notification-service
    key: "${TRADEMASTER_NOTIFICATION_SERVICE_API_KEY}"
    tags:
      - api-key
      - internal
      - notification

  - consumer: trademaster-billing-service
    key: "${TRADEMASTER_BILLING_SERVICE_API_KEY}"
    tags:
      - api-key
      - internal
      - billing

# ==================== CERTIFICATES (HTTPS) ====================
certificates:
  - cert: |
      -----BEGIN CERTIFICATE-----
      # Your SSL certificate here for subscription service
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      # Your private key here for subscription service
      -----END PRIVATE KEY-----
    tags:
      - ssl
      - https
      - subscription

# ==================== SNIs ====================
snis:
  - name: subscription-api.trademaster.com
    certificate: certificates[0]
    tags:
      - domain
      - production
      - subscription

  - name: staging-subscription-api.trademaster.com
    certificate: certificates[0]
    tags:
      - domain
      - staging
      - subscription